<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" id="userguide">
<head>
  <meta charset="utf-8"/>
  <title>User's Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/>
  <link rel="stylesheet" href="style.css"/>
  
</head>
<body>

<div id="logo">
  <h1><a href="."><img src="img/acmetool-logo-black.png" alt="acmetool - Let's Encrypt Client" /></a></h1>
</div>
<nav id="tnav">
<ul>
  <li><a href="userguide">User's Guide</a></li>
  <li><a href="acmetool.8">man acmetool</a></li>
  <li><a href="https://github.com/hlandau/acme/blob/master/README.md">README</a></li>
  <li><a href="https://github.com/hlandau/acme/releases">Download Binaries</a></li>
  <li><a href="https://github.com/hlandau/acme">Source Code</a></li>
</ul>
</nav>

<div id="obody">
<header>
<h1 class="title">User's Guide</h1>
</header>

<nav id="TOC"><ul>
<li><a href="#introduction-design-philosophy">Introduction &amp; Design Philosophy</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#after-installation">After installation</a></li>
<li><a href="#web-server-configuration-challenges">Web server configuration: challenges</a></li>
<li><a href="#web-server-configuration-tls">Web server configuration: TLS</a></li>
<li><a href="#challenge-completion-philosophy">Challenge completion philosophy</a></li>
<li><a href="#the-state-storage-schema">The state storage schema</a></li>
<li><a href="#response-files">Response files</a></li>
<li><a href="#hooks">Hooks</a><ul>
<li><a href="#notification-hooks">Notification hooks</a></li>
<li><a href="#challenge-hooks">Challenge hooks</a></li>
</ul></li>
<li><a href="#command-line-options">Command line options</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#faq">FAQ</a><ul>
<li><a href="#ive-selected-the-webrootproxyredirectorlistener-challenge-method-but-im-seeing-log-entries-for-other-methods-or-for-webroots-other-than-the-one-i-configured.">I've selected the (webroot/proxy/redirector/listener) challenge method, but I'm seeing log entries for other methods, or for webroots other than the one I configured.</a></li>
</ul></li>
<li><a href="#annex-root-configured-non-root-operation">Annex: Root-configured non-root operation</a><ul>
<li><a href="#rootless-setup-as-root">Rootless setup as root</a></li>
</ul></li>
<li><a href="#annex-external-resources-and-third-party-extentions">Annex: External resources and third party extentions</a></li>
</ul></nav>
<h2 id="introduction-design-philosophy">Introduction &amp; Design Philosophy</h2>
<p>acmetool is an easy-to-use command line tool for automatically acquiring TLS certificates from ACME servers such as Let's Encrypt, designed to flexibly integrate into your webserver setup to enable automatic verification.</p>
<p><strong>Non-interference.</strong> Unlike the official Let's Encrypt client, this doesn't modify your web server configuration.</p>
<p><strong>Target-oriented and idempotent.</strong> acmetool is designed to work like “make”: you specify what certificates you want, and acmetool obtains certificates as necessary to satisfy those requirements. If the requirements are already satisfied, acmetool doesn't do anything when invoked. Thus, acmetool is ideally suited for use on a cron job; it will do nothing until certificates are near expiry, and then obtain new ones.</p>
<p><strong>Clear and minimal state.</strong> acmetool is designed to minimise the use of state and be transparent in the state that it does use. All state, including certificates, is stored in a single directory, by default <code>/var/lib/acme</code>. The schema for this directory is simple, comprehensible and <a href="https://github.com/hlandau/acme/blob/master/_doc/SCHEMA.md">documented.</a></p>
<p><strong>Stable filenames.</strong> The certificate for a given hostname <code>example.com</code> always lives at <code>/var/lib/acme/live/example.com/{cert,chain,privkey}</code>. This is a symlink to the real certificate directory and gets changed as certificates are renewed.</p>
<p><strong>Fully automatic renewal.</strong> acmetool can automatically reload your webserver when it changes the target of a <code>live</code> symlink. In conjunction with acmetool's use of stable filenames and idempotent design, this means that renewal can be fully automatic.</p>
<p><strong>Flexible validation methods.</strong> acmetool supports six different validation methods:</p>
<ul>
<li><p><strong>Webroot:</strong> acmetool places challenge files in a given directory, allowing your normal web server to serve them. You must ensure the directory is served at <code>/.well-known/acme-challenge/</code>.</p></li>
<li><p><strong>Proxy:</strong> When acmetool needs to validate for a domain, it temporarily spins up a built-in web server on port 402 or 4402 (if being used under the non-root validation mode). You configure your web server to proxy requests for <code>/.well-known/acme-challenge/</code> to this server at the same path.</p></li>
<li><p><strong>Stateless:</strong> You configure your webserver to respond statelessly to challenges for a given account key without consulting acmetool. This requires nothing more than a one-time web server configuration change and no “moving parts”.</p></li>
<li><p><strong>Redirector:</strong> If the only thing you want to do with port 80 is redirect people to port 443, you can use acmetool's built in redirector HTTP server. You must ensure that your existing web server does not listen on port 80. acmetool redirects requests to HTTPS, but its control of port 80 ensures it can complete validation.</p></li>
<li><p><strong>Listen:</strong> Listen on port 80 or 443. This is only really useful for development purposes.</p></li>
<li><p><strong>Hook:</strong> You can write custom shell scripts or binary executables which acmetool invokes to provision challenges at the desired location.</p></li>
</ul>
<p><strong>Non-root operation.</strong> If you don't want to trust acmetool, you can setup acmetool to operate without running as root. If you don't have root access to a system, you may still be able to use acmetool by configuring it to use a local directory and webroot mode.</p>
<p><strong>Designed for automation.</strong> acmetool is designed to be fully automatable. Response files allow you to run the quickstart wizard automatically.</p>
<h2 id="installation">Installation</h2>
<p>You can install acmetool by building from source or by using a binary release. Both are easy.</p>
<p><strong>Installing: using binary releases.</strong> <a href="https://github.com/hlandau/acme/releases">Binary releases are found here.</a> Unpack, copy the binary to <code>/usr/local/bin/acmetool</code> (or wherever you like), and you're done.</p>
<p><code>_cgo</code> releases are preferred over non-<code>_cgo</code> releases where available, but non-<code>_cgo</code> releases may be more compatible with older OSes. (The main drawback of non-<code>_cgo</code> releases is that they exhibit reduced functionality in relation to privilege dropping and daemonization functionality for the redirector daemon.)</p>
<p><strong>Installing: Ubuntu users.</strong> A binary release PPA, <code>ppa:hlandau/rhea</code> (package <code>acmetool</code>) is available.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">sudo</span> add-apt-repository ppa:hlandau/rhea
$ <span class="fu">sudo</span> apt-get update
$ <span class="fu">sudo</span> apt-get install acmetool</code></pre></div>
<p>You can also <a href="https://launchpad.net/~hlandau/+archive/ubuntu/rhea/+packages">download .deb files manually.</a></p>
<p>(Note: There is no difference between the .deb files for different Ubuntu release codenames; they are interchangeable and completely equivalent.)</p>
<p><strong>Installing: Debian users.</strong> The Ubuntu binary release PPA also works with Debian:</p>
<pre><code># echo &#39;deb http://ppa.launchpad.net/hlandau/rhea/ubuntu xenial main&#39; &gt; /etc/apt/sources.list.d/rhea.list
# apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 9862409EF124EC763B84972FF5AC9651EDB58DFA
# apt-get update
# apt-get install acmetool</code></pre>
<p>You can also <a href="https://launchpad.net/~hlandau/+archive/ubuntu/rhea/+packages">download .deb files manually.</a></p>
<p>(Note: There is no difference between the .deb files for different Ubuntu release codenames; they are interchangeable and completely equivalent.)</p>
<p><strong>Installing: RPM-based distros:</strong> <a href="https://copr.fedorainfracloud.org/coprs/hlandau/acmetool/">A copr RPM repository is available.</a></p>
<p>If you have <code>dnf</code> installed:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">sudo</span> dnf copr enable hlandau/acmetool
$ <span class="fu">sudo</span> dnf install acmetool</code></pre></div>
<p>Otherwise use the <code>.repo</code> files on the <a href="https://copr.fedorainfracloud.org/coprs/hlandau/acmetool/">repository page</a> and use <code>yum</code>, or download RPMs and use <code>rpm</code> directly.</p>
<p><strong>Installing: Arch Linux users.</strong> <a href="https://aur.archlinux.org/packages/acmetool-git/">An AUR PKGBUILD for building from source is available.</a></p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">wget</span> https://aur.archlinux.org/cgit/aur.git/snapshot/acmetool-git.tar.gz
$ <span class="fu">tar</span> xvf acmetool-git.tar.gz
$ <span class="bu">cd</span> acmetool-git
$ <span class="ex">makepkg</span> -s
$ <span class="fu">sudo</span> pacman -U ./acmetool*.pkg.tar.xz</code></pre></div>
<p><strong>Installing: Alpine Linux users.</strong> <a href="https://github.com/hlandau/acme/blob/master/_doc/APKBUILD">An APKBUILD for building from source is available.</a></p>
<p><strong>Installing: from source.</strong> Clone, make, make install. You will need Go 1.5.2 or later installed to build from source.</p>
<p>If you are using Linux, you will need to make sure the development files for <code>libcap</code> are installed. This is probably a package for your distro called <code>libcap-dev</code> or <code>libcap-devel</code> or similar.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">git</span> clone https://github.com/hlandau/acme
$ <span class="bu">cd</span> acme
$ <span class="fu">make</span> <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> make install</code></pre></div>
<p><strong>Installing: from source (existing GOPATH).</strong> The Makefile is intended to make things easy for users unfamiliar with Go packaging conventions. If you know what a GOPATH is and have one set up, you can and should instead simply do:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="ex">go</span> get -u github.com/hlandau/acme/cmd/acmetool
$ <span class="fu">sudo</span> cp <span class="va">$GOPATH</span>/bin/acmetool /usr/local/bin/acmetool</code></pre></div>
<p>(Note: Although use of cgo is recommended, building without cgo is supported.)</p>
<h2 id="after-installation">After installation</h2>
<p><strong>Initial configuration.</strong> Having installed acmetool, run the quickstart wizard for a guided setup. You may wish to ensure you have <code>dialog</code> in your PATH, but acmetool will fallback to basic stdio prompts if it's not available.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">sudo</span> acmetool quickstart</code></pre></div>
<p>If you don't want to run acmetool as root, see the <a href="#annex-root-configured-non-root-operation">non-root setup guide</a>.</p>
<p>Pass <code>--expert</code> to quickstart if you want to choose what key parameters to use (RSA or ECDSA, RSA key size, ECDSA curve). By default 2048-bit RSA is used.</p>
<p>If you want to automate the quickstart process, see the section on response files below.</p>
<p>It is safe to rerun quickstart at any time.</p>
<p><strong>Configuring your web server.</strong> Once you've completed the quickstart, you should configure your web server as necessary to enable validation. See the <em>Web server configuration</em> section below.</p>
<p><strong>Obtaining certificates.</strong> Once everything's ready, simply run:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">sudo</span> acmetool want example.com www.example.com</code></pre></div>
<p>This adds a target desiring a certificate for hostnames <code>example.com</code> and <code>www.example.com</code>. You can specify as many hostnames (SANs) as you like. Whenever you run acmetool in the future, it'll make sure that a certificate for these hostnames is available and not soon to expire.</p>
<p>acmetool lumps hostnames together in the same certificate. If you want <code>example.com</code> and <code>www.example.com</code> to be separate certificates, use separate <code>want</code> commands to configure them as separate targets:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">sudo</span> acmetool want example.com
$ <span class="fu">sudo</span> acmetool want www.example.com</code></pre></div>
<p>If all went well, your certificate should be available at <code>/var/lib/acme/live/example.com</code>. This is a directory containing PEM files <code>cert</code>, <code>chain</code>, <code>fullchain</code> and <code>privkey</code>. The use of these files varies by application; typically you will use only a subset of these files.</p>
<p><strong>Troubleshooting.</strong> If all didn't go well, you might find it helpful to run with debug logging:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">sudo</span> acmetool --xlog.severity=debug</code></pre></div>
<p>(There's no need to run “want” again; the targets are recorded even if reconciliation is not successful.)</p>
<p><strong>Auto-renewal.</strong> acmetool offers to install a cronjob during the quickstart process. This simply runs <code>acmetool --batch</code>, which will idempotently ensure that all configured targets are satisfied by certificates not soon to expire. (<code>--batch</code> here ensures that acmetool doesn't try to ask any questions.)</p>
<p><strong>Auto-renewal: reloading your webserver.</strong> When acmetool refreshes a certificate, it changes the symlink in <code>live</code> and executes hook scripts to reload your web server or do whatever you want. Specifically, it executes any executable files in <code>/usr/lib/acme/hooks</code> (or <code>/usr/libexec/acme/hooks</code> if on a distro that uses libexec). You can drop your own executable files here, and acmetool will invoke them when it changes certificates. (For information on the calling convention, see <a href="https://github.com/hlandau/acme/blob/master/_doc/SCHEMA.md#notification-hooks">SCHEMA.md</a>.)</p>
<p><code>acmetool quickstart</code> installs some default hooks applicable to common webservers. These hooks contain the string <code>#!acmetool-managed!#</code>. acmetool reserves the right to overwrite any file containing this string with a newer version of the script, in the event that the default scripts are updated in subsequent versions of acmetool. If you make changes to a default script and do not wish them to be overwritten, you should remove this line to ensure that your changes are not overwritten. However, note that the default hook scripts are designed to be configurable and it will be rare that you need to modify the scripts themselves. If you encounter a situation where you need to change the script itself, you may consider whether it would be appropriate to file an enhancement request. The string <code>#!acmetool-managed!#</code> must be present near the start of the file in order to be detected.</p>
<p>If you want to disable a default hook entirely, you should replace it with an empty file rather than deleting it, as <code>acmetool quickstart</code> will automatically install absent default hooks.</p>
<p><strong>Default hook scripts: the <code>reload</code> hook.</strong> The reload hook is a default hook installed by <code>acmetool quickstart</code>. It reloads a list of services using commands specific to the distro. The correct command is detected automatically; <code>service $SERVICE reload</code>, <code>systemctl reload $SERVICE</code>, and <code>/etc/init.d/$SERVICE reload</code> are supported.</p>
<p>A default list of services is provided which includes the most common webserver service names. This list can be customised using the <code>reload</code> hook configuration file.</p>
<p>The <code>reload</code> hook configuration file is located at <code>/etc/conf.d/acme-reload</code> or <code>/etc/default/acme-reload</code>; the correct path depends on the conventions of your distro. It is a sourced shell file which can modify the default configuration variables of the <code>reload</code> script. Currently, the only variable is the <code>SERVICES</code> variable, a space-separated list of service names.</p>
<p>You can overwrite the services list outright, or append to it like so:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># Example reload hook configuration file adding a service to the list of</span>
<span class="co"># services to be restarted.</span>
<span class="va">SERVICES=</span><span class="st">&quot;</span><span class="va">$SERVICES</span><span class="st"> cherokee&quot;</span></code></pre></div>
<p><strong>Default hook scripts: the <code>haproxy</code> hook.</strong> The haproxy hook is a default hook which <code>acmetool quickstart</code> can optionally install. It only offers to install this hook if HAProxy is detected as being installed on the system.</p>
<p>HAProxy is rather bizarre in its TLS configuration requirements; it requires certificates and private key to be appended together in the same file. <code>acmetool</code> does not support this natively and is unlikely ever to as a default configuration for security reasons. Instead, the <code>haproxy</code> hook creates the necessary files for HAProxy from the certificate and private key files whenever they are updated. Thus, additional copies of the private key are only made when necessary to support HAProxy.</p>
<p><strong>Inside the state directory.</strong> acmetool aims to minimise the use of state and be transparent about the state it does keep. When you run <code>acmetool want</code>, acmetool does these things:</p>
<ul>
<li><p>It configures a new target by writing a YAML file to <code>/var/lib/acme/desired/</code> describing the desired hostnames.</p></li>
<li><p>It runs the default command, <code>reconcile</code>, to ensure that all targets are met.</p></li>
</ul>
<p>To demonstrate, you can replicate the function of <code>acmetool want</code>:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash">$ <span class="fu">sudo</span> touch /var/lib/acme/desired/example.com
$ <span class="fu">sudo</span> acmetool</code></pre></div>
<p>Target files live in the <code>desired</code> directory. An empty target file defaults to its filename as the target hostname.</p>
<p><a href="https://github.com/hlandau/acme/blob/master/_doc/SCHEMA.md">More information on the format of the acmetool state directory and target files.</a></p>
<h2 id="web-server-configuration-challenges">Web server configuration: challenges</h2>
<p>What web server configuration you need to do depends on the validation method you have selected.</p>
<p><strong>Redirector mode.</strong> No configuration required, but ensure that your web server is not listening on port 80 and that the redirector service (<code>acmetool redirector --service.daemon --service.uid=</code><em>uid-to-drop-privileges-to</em>) is started.</p>
<p><strong>Proxy mode: nginx/tengine.</strong> You can configure nginx/tengine for use with acmetool in proxy mode as follows:</p>
<pre class="nginx"><code>http {
  server {
    ... your configuration ...

    location /.well-known/acme-challenge/ {
      proxy_pass http://acmetool;
    }
  }

  upstream acmetool {
    # (Change to port 4402 if using non-root mode.)
    server 127.0.0.1:402;
  }
}</code></pre>
<p>This configuration will need to be repeated for each vhost. You may wish to avoid duplication by placing the applicable configuration in a separate file and including it in each vhost.</p>
<p><strong>Proxy mode: Apache httpd.</strong></p>
<div class="sourceCode"><pre class="sourceCode apache"><code class="sourceCode apache"><span class="co"># (Change to port 4402 if using non-root mode.)</span>
ProxyPass<span class="st"> &quot;/.well-known/acme-challenge&quot; &quot;http://127.0.0.1:402/.well-known/acme-challenge&quot;</span></code></pre></div>
<p>Ensure you load the modules <code>mod_proxy</code> and <code>mod_proxy_http</code>.</p>
<p><strong>Proxy mode: Changing port.</strong> If you need to change the ports on which acmetool listens, see the <code>request: challenge: http-ports</code> directive. See <a href="#the-state-storage-schema">State storage schema</a>.</p>
<p><strong>Webroot mode.</strong> If you don't have a particular webroot path in mind, consider using <code>/var/run/acme/acme-challenge</code> as a recommended standard. <code>acmetool</code> defaults to this as a webroot path if you don't explicitly configure one. (See “Challenge Completion Philosophy” below.)</p>
<p><strong>Webroot mode: nginx/tengine.</strong></p>
<pre class="nginx"><code>http {
  server {
    location /.well-known/acme-challenge/ {
      alias /var/run/acme/acme-challenge/;
    }
  }
}</code></pre>
<p>Note that the configuration will need to be repeated for each vhost. You may wish to avoid duplication by placing the applicable configuration in a separate file and including it in each vhost.</p>
<p><strong>Webroot mode: Apache httpd.</strong></p>
<div class="sourceCode"><pre class="sourceCode apache"><code class="sourceCode apache">Alias<span class="st"> &quot;/.well-known/acme-challenge/&quot; &quot;/var/run/acme/acme-challenge/&quot;</span>
<span class="fu">&lt;Directory</span><span class="at"> &quot;/var/run/acme/acme-challenge&quot;</span><span class="fu">&gt;</span>
  <span class="ex">AllowOverride</span><span class="ch"> </span><span class="kw">None</span>
  <span class="ex">Options</span><span class="ch"> </span><span class="kw">None</span>

  <span class="co"># If using Apache 2.4+</span>
  Require<span class="st"> all granted</span>

  <span class="co"># If using Apache 2.2 and lower</span>
  <span class="ex">Order</span><span class="ch"> allow, deny</span>
  Allow<span class="st"> from all</span>
<span class="fu">&lt;/Directory&gt;</span></code></pre></div>
<p><strong>Hook mode.</strong> See <a href="#challenge-hooks">Challenge Hooks</a>.</p>
<p><strong>Stateless mode.</strong> In stateless mode, you configure your webserver to respond to challenge requests without consulting acmetool. A single account key is nominated. This is one of the most reliable and least error-prone methods for simple cases.</p>
<p><strong>Stateless mode: nginx/Tengine.</strong></p>
<p>Replace <code>ACCOUNT_THUMBPRINT</code> in the example below with your account thumbprint. You can retrieve your account thumbprint by running <code>acmetool account-thumbprint</code>. The first part of each line output is the account thumbprint.</p>
<pre class="nginx"><code>http {
  server {
    location ~ &quot;^/\.well-known/acme-challenge/([-_a-zA-Z0-9]+)$&quot; {
      default_type text/plain;
      return 200 &quot;$1.ACCOUNT_THUMBPRINT&quot;;
    }
  }
}</code></pre>
<p><strong>Stateless mode: Apache.</strong> It does not appear that the configuration system of Apache can currently express the needed behaviour.</p>
<h2 id="web-server-configuration-tls">Web server configuration: TLS</h2>
<p>Mozilla has a <a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">TLS configuration generator</a> that you can use to generate configurations for common web servers.</p>
<h2 id="challenge-completion-philosophy">Challenge completion philosophy</h2>
<p>acmetool's philosophy to completing challenges is to try absolutely anything that might work. So long as <em>something</em> works, acmetool doesn't care what it was that worked. When <code>acmetool quickstart</code> asks you what method to use, this is asked purely to determine a) whether to ask you for a webroot path (if you selected webroot mode) and b) whether to ask you if you want to install the redirector service (if you selected redirector mode and are using systemd, for which automatic service installation is supported). It doesn't determine what strategies acmetool does or doesn't use, so it's normal to see log output relating to a failure to use methods other than the one you chose.</p>
<p>acmetool always tries to listen on port 402 and 4402 when completing challenges, in case something proxies to it. It always tries to listen on ports 80 and 443, in case you're not running a webserver yet. And it always tries to place challenge files in any webroot paths you have configured. Finally, it always tries to place challenge files in <code>/var/run/acme/acme-challenge</code>; this serves as a standard location for challenge files, and the redirector daemon works by looking here.</p>
<p>Failure to complete any of these efforts is non-fatal. Ultimately, all acmetool cares about is that a challenge completes successfully after having attempted all possible preparations. It doesn't know or care <em>why</em> a challenge succeeds, only that it succeeded.</p>
<p>(For HTTP-based challenges, acmetool self-tests its ability to complete the challenge by issuing a request for the same URL which will be requested by the ACME server, and does not proceed if this does not validate. Thus, HTTP-based challenges will never work if you are running some sort of weird split-horizon configuration where challenge files are retrievable only from the internet but not the local machine.)</p>
<h2 id="the-state-storage-schema">The state storage schema</h2>
<p><a href="https://github.com/hlandau/acme/blob/master/_doc/SCHEMA.md">The format of acmetool's state directory is authoritatively documented here.</a> What follows is a summary of the more important parts.</p>
<p><strong><code>live</code> directory:</strong> Contains symlinks from hostnames to certificate directories. Each certificate directory contains <code>cert</code>, <code>chain</code>, <code>fullchain</code> and <code>privkey</code> files. (If you are using HAProxy and have chosen to install the HAProxy hook script, a <code>haproxy</code> file will also be available containing key, certificate and chain all in one.)</p>
<p>You should configure your web server in terms of paths like <code>/var/lib/acme/live/example.com/{cert,chain,fullchain,privkey}</code>.</p>
<p><strong><code>desired</code> directory:</strong> Contains targetfiles. These determine the certificates which will be requested. Each target file is a YAML file, split into two principal sections: the <code>satisfy</code> section and the <code>request</code> section.</p>
<p>The <code>satisfy</code> section dictates what conditions must be met in order for a certificate to meet a target (and thus be selected for symlinking under the <code>live</code> directory). The <code>request</code> section dictates the parameters for requesting new certificates, but nothing under it determines <em>whether</em> a certificate is requested.</p>
<p>Finally, the <code>priority</code> value determines which target is used for a hostname when there are multiple targets for the same hostname. Higher priorities take precedence. The default priority is 0.</p>
<p>In most cases, you will set only <code>satisfy.names</code> in a target file, and will set all other settings in the <em>default target file</em>, which is located at <code>conf/target</code>. The quickstart wizard sets this file up for you. All settings in the default target file are inherited by targets, but can be overridden individually.</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">satisfy:</span>
  <span class="fu">names:</span>
    <span class="kw">-</span> example.com       <span class="co"># The names you want on the certificate.</span>
    <span class="kw">-</span> www.example.com

<span class="fu">request:</span>
  <span class="fu">provider:</span><span class="at">               </span><span class="co"># ACME Directory URL. Normally set in conf/target only.</span>
  <span class="fu">ocsp-must-staple:</span><span class="at"> true  </span><span class="co"># Request OCSP Must Staple. Use with care.</span>
  <span class="fu">challenge:</span>
    <span class="fu">webroot-paths:</span><span class="at">        </span><span class="co"># You can specify custom webroot paths.</span>
      <span class="kw">-</span> /var/www
    <span class="fu">http-ports:</span><span class="at">           </span><span class="co"># You can specify different ports for proxying.</span>
      <span class="kw">-</span> 123               <span class="co"># Defaults to listening on localhost.</span>
      <span class="kw">-</span> 456
      <span class="kw">-</span> <span class="fu">0.0.0.0:</span><span class="at">789       </span><span class="co"># Global listen.</span>
    <span class="fu">http-self-test:</span><span class="at"> false </span><span class="co"># Defaults to true. If false, will not perform self-test</span>
                          <span class="co"># but will assume challenge can be completed. Rarely needed.</span>
    <span class="fu">env:</span><span class="at">                  </span><span class="co"># Optionally set environment variables to be passed to hooks.</span>
      <span class="fu">FOO:</span><span class="at"> BAR</span>
  <span class="fu">key:</span><span class="at">                    </span><span class="co"># What sort of key will be used for this certificate?</span>
    <span class="fu">type:</span><span class="at"> rsa|ecdsa</span>
    <span class="fu">rsa-size:</span><span class="at"> 2048</span>
    <span class="fu">ecdsa-curve:</span><span class="at"> nistp256</span>
    <span class="fu">id:</span><span class="at"> krzh2akn...       </span><span class="co"># If specified, the key ID to use to generate new certificates.</span>
                          <span class="co"># If not specified, a new private key will always be generated.</span>
                          <span class="co"># Useful for key pinning.</span>

<span class="fu">priority:</span><span class="at"> 0</span></code></pre></div>
<p><strong>HAProxy support:</strong> If you have chosen to install the HAProxy hook script, each certificate directory will also have a coalesced <code>haproxy</code> file containing certificate chain and private key. There will also be a <code>haproxy</code> directory mapping from hostnames directly to these files.</p>
<p><strong><code>accounts</code> directory:</strong> ACME account keys and state information. You don't need to worry about this.</p>
<p><strong><code>certs</code> and <code>keys</code></strong>: Contains certificates and keys used to satisfy targets. However, you should never need to reference these directories directly.</p>
<p>Please note that it is a requirement that the state directory not straddle filesystem boundaries. That is, all files under <code>/var/lib/acme</code> must lie on the same filesystem.</p>
<h2 id="response-files">Response files</h2>
<p>It is possible to automatically provide responses to any question acmetool can ask.</p>
<p>To do this, you provide the <code>--response-file</code> flag, with the path to a YAML file containing response information. <a href="https://github.com/hlandau/acme/blob/master/_doc/response-file.yaml">An example of such a file is here.</a></p>
<p>If you don't provide a <code>--response-file</code> flag, acmetool will try to look for one at <code>/var/lib/acme/conf/responses</code>. If using a response file, it's recommended that you place it at this location.</p>
<p>The file specifies key-value pairs. Each key is a prompt ID. (You can find these by grepping the source code for <code>UniqueID</code>.)</p>
<p>(For messages which simply require acknowledgement, specify <code>true</code> to bypass them. Yes/no prompts should have a boolean value specified. The example response file is demonstrative.)</p>
<p>You should specify <code>--batch</code> when using a response file to prevent acmetool from trying to prompt the user and fail instead, in case it tries to ask anything which you don't have a response for in your response file.</p>
<h2 id="hooks">Hooks</h2>
<p>Hooks provide a means to extend acmetool with arbitrary behaviour. Hooks are executable files installed by default at <code>/usr/lib/acme/hooks</code> (or, on systems which use <code>/usr/libexec</code>, <code>/usr/libexec/acme/hooks</code>).</p>
<p>The event type is always passed as the first argument. A hook must exit with exit code 42 for event types it doesn't handle.</p>
<p>There are currently two types of hook: notification hooks and challenge hooks.</p>
<h3 id="notification-hooks">Notification hooks</h3>
<p>The quickstart wizard installs default notification hooks to reload common webservers and other services after acmetool changes the preferred certificate for a hostname. These hooks are executable shell scripts and you can, if you wish, substitute your own. The default hooks are good bases from which to make your own customisations.</p>
<p>You can use notification hooks to reload webservers, distribute certificates and private keys to other servers, or convert certificates and private keys into another format which is required by some daemon. For example, HAProxy support is implemented entirely via hook.</p>
<p>The event type is &quot;live-updated&quot;.</p>
<h3 id="challenge-hooks">Challenge hooks</h3>
<p>In some complex use cases, it may be necessary to install HTTP challenge files via some arbitrary programmatic means, rather than via one of the standard methods of webroot, proxy, redirector or listener.</p>
<p>Challenge hooks are executed when challenge files need to be added or removed. Your hook must be synchronous; it must exit only when the challenge file is definitely in place and is globally accessible.</p>
<p><a href="https://github.com/hlandau/acme/blob/master/_doc/SCHEMA.md#hooks">See the specification for more information.</a></p>
<p>Challenge hooks are supported for HTTP, TLS-SNI and DNS challenges. <a href="https://hlandau.github.io/acme/userguide#annex-external-resources-and-third-party-extentions">A list of third party challenge hook scripts can be found here.</a></p>
<h2 id="command-line-options">Command line options</h2>
<p><a href="acmetool.8">See the acmetool(8) manual page.</a></p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Passing <code>--xlog.severity=debug</code> increases the logging verbosity of acmetool and should be your first troubleshooting strategy.</p>
<h2 id="faq">FAQ</h2>
<h3 id="ive-selected-the-webrootproxyredirectorlistener-challenge-method-but-im-seeing-log-entries-for-other-methods-or-for-webroots-other-than-the-one-i-configured.">I've selected the (webroot/proxy/redirector/listener) challenge method, but I'm seeing log entries for other methods, or for webroots other than the one I configured.</h3>
<p>This is normal. By design, acmetool always tries anything which might work, and these errors are nonfatal as long as <em>something</em> works. The challenge method you select in the quickstart wizard determines only whether to ask you for a webroot path, and whether to install the redirector (if you are using system). The webroot path <code>/var/run/acme/acme-challenge</code>, as a standard location, will always be tried in addition to any webroot you specify, as will proxy and listener mode ports.</p>
<p>Fore more information, see <a href="https://hlandau.github.io/acme/userguide#challenge-completion-philosophy">challenge completion philosophy</a>.</p>
<h2 id="annex-root-configured-non-root-operation">Annex: Root-configured non-root operation</h2>
<p>The following steps describe how you can, as root, take a series of steps that allows you to invoke acmetool as a non-root user, thereby limiting your attack surface and the degree to which you trust acmetool.</p>
<p>It is also possible to use acmetool without you having access to root at all. In this case, place acmetool in a location of your choice and pass the <code>--state</code> and <code>--hooks</code> flags with appropriate paths of your choice to all invocations of acmetool.</p>
<h3 id="rootless-setup-as-root">Rootless setup as root</h3>
<p>acmetool has experimental support for root-free operation.</p>
<p>In order to run root-free, after installing acmetool in <code>/usr/local/bin</code> (or wherever you want it), before running acmetool, do the following:</p>
<ul>
<li><p>Create a new user <code>acme</code> <small>(or whatever you want)</small>.</p></li>
<li><p>Create the directory <code>/var/lib/acme</code> and change the owning user and group to <code>acme</code>. <small>(You can use a different directory, but you must then make sure you pass <code>--state PATH</code> to all invocations of acmetool.)</small></p></li>
<li><p>Create the directory <code>/usr/lib/acme/hooks</code> <small>(<code>/usr/libexec/acme/hooks</code> on distros which use libexec)</small>. Make it writable by <code>acme</code> for the time being by changing the group to <code>acme</code> and making the directory group-writable. (You can make this read-only after running the quickstart process, which places some shell scripts in here to reload servers. You can audit these scripts yourself or use your own if you wish.)</p></li>
<li><p>Change to the user <code>acme</code> and run <code>acmetool quickstart</code>.</p>
<pre><code>$ sudo -u acme acmetool quickstart</code></pre>
<p>A crontab will be installed automatically as the <code>acme</code> user; you may wish to examine it.</p></li>
<li><p>As root, make the <code>hooks</code> directory root-owned/not group writable once more. Ensure that the scripts are root-owned:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># chown -R root:root /usr/lib*/acme/hooks</span>
<span class="co"># chmod 755 /usr/lib*/acme/hooks</span></code></pre></div>
<p>Inspect the hook scripts if you wish. Mark the hook scripts setuid:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># chmod u+s /usr/lib*/acme/hooks/*</span></code></pre></div>
<p>UNIX systems don't support setuid shell scripts, so this bit is ignored. Rather, acmetool takes it as a flag to tell it to run these scripts via <code>sudo</code>. This is necessary so that web servers, etc. can be reloaded.</p>
<p>The conditions for running using <code>sudo</code> are that the files have the setuid bit set, that they be owned by root, that they be scripts and not binaries, and that acmetool is not being run as root.</p></li>
<li><p>Setup sudo. You will need to edit the sudoers file so that the hook scripts (which you have inspected and trust) can be executed by acmetool. It is essential that these have the <code>NOPASSWD</code> flag as the scripts must be executable noninteractively.</p>
<p><code># visudo</code></p>
<p>Add the line:</p>
<p><code>acme ALL=(root) NOPASSWD: /usr/lib/acme/hooks/</code></p></li>
<li><p>Setup your challenge method:</p>
<p><strong>Webroot:</strong> Make sure the <code>acme</code> user can write to the webroot directory you configured.</p>
<p><strong>Redirector:</strong> Make sure the directory <code>/var/run/acme/acme-challenge</code> is writable by the <code>acme</code> user. <code>acmetool</code> puts challenges here because the redirector looks here (internally it's a glorified webroot mode).</p>
<p>Note that <code>/var/run</code> will be a tmpfs on many modern OSes, so the directory ceases to exist on reboots. The redirector will try to create the directory (as user root, mode 0755) if it doesn't exist. This happens before the redirector drops privileges from root. (It has to run as root initially to bind to port 80.)</p>
<p>A configuration option has been added to make the redirector ensure that the directory is writable by a certain group when starting up. When this option is used, mode 0775 is used instead and the group owner is changed to a given GID.</p>
<p>Pass <code>--challenge-gid=GID</code> to <code>acmetool redirector</code> (edit your service manager's configuration, e.g. the systemd unit file), where GID is the numeric group ID of the group owner for the challenge directory (i.e. the GID of the <code>acme</code> group). (Group names rather than IDs may be supported on some platforms, but this is not guaranteed and will vary. Use of a GID is recommended.)</p>
<p><strong>Proxy:</strong> If you are using the proxy method, you won't be able to listen on port 402 as a non-root user. Use port 4402 instead, which acmetool will try also try to use.</p>
<p><strong>Listener:</strong> This is not usable under non-root operation unless you can enable acmetool to bind to ports 80/443. On Linux you can do this by running <code>setcap 'cap_net_bind_service=+ep' /path/to/acmetool</code> as root. Other POSIX platforms may have sysctls to allow non-root processes to bind to low ports. However, this mode is not really useful for anything other than development anyway.</p>
<p><strong>Hook:</strong> See <a href="#challenge-hooks">Challenge Hooks</a>.</p></li>
</ul>
<h2 id="annex-external-resources-and-third-party-extentions">Annex: External resources and third party extentions</h2>
<p>The list of various tutorials, hook scripts and other integrations people have made for acmetool is now maintained <a href="https://github.com/hlandau/acme/wiki/ThirdPartyResources">in the wiki</a>.</p>
<ul>
<li><strong><a href="https://github.com/hlandau/acme/wiki/ThirdPartyResources">List of third party resources</a></strong></li>
</ul>
</div>

</body>
</html>
